<% layout('/template/adminBoilerplate') -%>
 
                    <div class="container my-5">
                        <div class="row">
                            <div class="col-12 text-center">
                                <h3>Course Details</h3>
                            </div>
                        </div>
                        <div class="container mt-5">
                            <div class="row mt-5">
                                    <form action="<%= devFun %>/adminEditCourse/<%=uid%>?_method=PUT" method="post"
                                        class=" col-8 col-lg-12 " novalidate>
                                        <div class="row">
                                            <div class="col-6 px-5 ">
                                                <div class="formInput mb-5">
                                                    <label for="CourseName" class="form-label text-white-50">Course
                                                        Name</label>
                                                    <input type="text" name="courseName" id="CourseName"
                                                        class="form-control text-light bg-transparent border-0 border-bottom border-info"
                                                        required value="<%= course.data().courseName %> ">
                                                </div>
                                                <div class="formInput mb-5">
                                                    <label for="instructorName"
                                                        class='form-label text-white-50'>Instructor
                                                        Name</label>
                                                    <input type="text" name="instructorName" id="instructorName"
                                                        class="form-control text-light bg-transparent border-0 border-bottom border-info"
                                                        required value="<%= course.data().instructorName %>">

                                                </div>
                                                <div class="formInput mb-5">
                                                    <label for="courseLanguage"
                                                        class="form-label text-white-50">Language</label>
                                                    <select name="courseLanguage" id="courseLanguage"
                                                        class="form-select text-light bg-transparent border-0 border-bottom border-info"
                                                        required>
                                                        <option value="Hindi" class="bg-dark"
                                                        <% if(course.data().courseLanguage=='Hindi'){%>
                                                            selected
                                                        <% } %> >Hindi</option>
                                                       <option value="English" class="bg-dark"
                                                       <% if(course.data().courseLanguage=='English'){%>
                                                        selected
                                                        <% } %> >English</option>
                                                        <option value="Other" class="bg-dark"
                                                        <% if(course.data().courseLanguage=='Other'){%>
                                                        selected
                                                        <% } %> >Other</option>
                                                    </select>

                                                </div>
                                                <div class="formInput mb-5">
                                                    <label for="previewLink" class='form-label text-white-50'>Paste link
                                                        for
                                                        preview
                                                        video <i class="fas fa-link"></i></label>
                                                    <input type="text" name="previewLink" id="previewLink"
                                                        class="form-control text-light bg-transparent border-0 border-bottom border-info"
                                                        required value="<%= course.data().previewLink %>">
                                                </div>
                                                <div class="mb-5">
                                                    <label for="courseDescription"
                                                        class="form-label  text-white-50">Course
                                                        Description</label><br>
                                                    <textarea name="courseDescription" id="courseDescription"
                                                        class="text-light bg-transparent border-0 border-bottom border-info w-100"
                                                        rows="4"><%= course.data().courseDescription %></textarea>
                                                </div>
                                               
                                            </div>
                                            <div class="col-6 px-5 ">
                                                <div class="formInput mb-5">
                                                    <label for="coursePrice"
                                                        class='form-label text-white-50'>Course Price</label>
                                                    <input type="number" name="coursePrice" id="coursePrice"
                                                        class="form-control text-light bg-transparent border-0 border-bottom border-info"  value="<%= course.data().coursePrice %>"
                                                        required>
                                                </div>
                                                <div class="formInput mb-5">
                                                    <label for="discountAmount"
                                                        class='form-label text-white-50'>Discount Amount</label>
                                                    <input type="number" name="discountAmount" id="discountAmount"
                                                        class="form-control text-light bg-transparent border-0 border-bottom border-info" value="<%= course.data().discountAmount %>"
                                                        required>
                                                </div>
                                                <div class="mb-5">
                                                    <label for=""
                                                        class="form-label text-white-50 mb-2">Highlights</label>
                                                    <div class="tags">
                                                        <input type="checkbox" class="btn-check" id="bestsellerTag"
                                                            autocomplete="off"  name="bestsellerTag" <% if(course.data().bestsellerTag=='on'){%>
                                                               checked
                                                            <% } %>>
                                                        <label class="me-2 btn btn-outline-info"
                                                            for="bestsellerTag">Bestseller</label>
                                                        <input type="checkbox" class="btn-check" id="beginnerTag"
                                                            autocomplete="off"  name="beginnerTag" <% if(course.data().beginnerTag=='on'){%>
                                                                checked
                                                            <% } %>>
                                                        <label class="me-2 btn btn-outline-info"
                                                            for="beginnerTag">Beginner</label>
                                                        <input type="checkbox" class="btn-check" id="IntermediateTag"
                                                            autocomplete="off" name="intermediateTag"<% if(course.data().intermediateTag=='on'){%>
                                                                checked
                                                            <% } %>>
                                                        <label class="me-2 btn btn-outline-info"
                                                            for="IntermediateTag"   >Intermediate</label>
                                                    </div>
                                                </div>
                                                <div class="mb-5">
                                                    <img src="<%= course.data().thumbnailURL %>" alt="" class="thumbnail" style="width:100%; height: 100%; object-fit: contain;" >
                                                </div>
                                                <div class="mb-5">
                                                    <label class="btn btn-info" id="btnUpload">Upload
                                                        course
                                                        thumbnail
                                                        <input type="file" id="inputUpload" hidden>
                                                    </label>
                                                </div>
                                                <div class="mt-2 text-center" id="progressBar"></div>
                                            </div>
                                            <div class="row">
                                                <div class="submit container w-50">
                                                    <div class="cta row justify-content-center">
                                                        <button type="submit"
                                                            class="col-6  btn btn-lg btn-info">Submit</button>
                                                    </div>
                                                </div>
                                            </div>
                                    </form>
                            </div>
                        </div>
                        <div class="row  mt-4 mb-5 d-flex justify-content-center">
                            <div class="btn btn-danger" style="width: fit-content;" id="btnDeleteCourse">Delete Course</div>
                        </div>
                        <div class="row w-100 my-5 ">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb d-flex justify-content-center">
                                    <li class="breadcrumb-item"><a href="<%= devFun %>/adminAllCourses/<%=uid%> ">All
                                            Courses</a></li>
                                    <li class="breadcrumb-item active" aria-current="page">Edit Course <%= course.data().courseName %> </li>
                                </ol>
                            </nav>
                        </div>
                    </div>
                    <form action="<%=devFun%>/adminDeleteCourse/<%=uid%>/<%=course.id%>?_method=DELETE"
                        method="post" id="deleteForm" hidden>
                    </form>
                    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
                    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
                    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
                    <script src="<%=devEnv%>__/firebase/init.js"></script>
                    <script>
                        var storage = firebase.storage();
                        const form = document.querySelector('form')
                        const btnUpload = document.querySelector('#btnUpload')
                        const inputUpload = document.querySelector('#inputUpload')
                        const thumbnailImg = document.querySelector('.thumbnail')
                        const courseID = '<%=course.id%>'
                        const imageID = courseID
                        const defaultPicURL =  '<%=course.data().thumbnailURL%>'
            
                        btnUpload.addEventListener('change', () => {
                            thumbnailImg.src =  URL.createObjectURL(inputUpload.files[0])
                        })
            
            
                        async function uploadImage(imagesRef) {
                                const file = inputUpload.files[0]
                                if(file)
                                {
                                    const uploadTask = imagesRef.put(file)
                                    uploadTask.on('state_changed', 
                                    (snapshot) => {
                                        // Observe state change events such as progress, pause, and resume
                                        // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
                                        var progress = parseInt((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                                        document.querySelector('#progressBar').innerText = 'Upload is ' + progress + '% done. Please wait.'
                                    }, 
                                    (error) => {
                                        // Handle unsuccessful uploads
                                        
                                        console.log('Error uploading image')
                                        console.log(error)
                                        //submitForm(defaultPicURL)
                                    }, 
                                    () => {
                                        // Handle successful uploads on complete
                                        // For instance, get the download URL: https://firebasestorage.googleapis.com/...
                                        uploadTask.snapshot.ref.getDownloadURL().then((downloadurl) => {
                                            submitForm(downloadurl)
                                        });
                                    }
                                    );
                                }
                                else{
                                    submitForm(defaultPicURL)
                                }
                        }
            
                        function submitForm(downloadURL) {
                            const imageInput = document.createElement('input')
                            imageInput.value = downloadURL
                            imageInput.name = 'thumbnailURL'
                            imageInput.hidden = true
                            form.append(imageInput)
                            const inputImageID = document.createElement('input')
                            inputImageID.value = imageID
                            inputImageID.name = 'thumbnailID'
                            inputImageID.hidden = true
                            form.append(inputImageID)
                            const inputCourseID = document.createElement('input')
                            inputCourseID.value = courseID
                            inputCourseID.name = 'courseID'
                            inputCourseID.hidden = true
                            form.append(inputCourseID)
                            form.submit()
                        }
            
                        form.addEventListener('submit', (event) => {
                            event.preventDefault()
                            event.stopPropagation()
                            var imagesRef = storage.ref().child('courses/' + imageID);
                            uploadImage(imagesRef)
                        })


                        async function removeImageAndDelete(imagesRef) {
                            try {
                                await imagesRef.delete()
                            } catch (error) {
                                console.log('error deleting image')
                                console.log(error)
                            }
                            finally {
                                const form = document.querySelector('#deleteForm')
                                form.submit()
                            }
                        }
                        document.querySelector('#btnDeleteCourse').addEventListener('click', () => {
                            if(confirm('Are you sure you want to delete the course?')==true){
                            var imagesRef = storage.ref().child('courses/' + '<%= course.data().thumbnailID %>');
                            removeImageAndDelete(imagesRef)
                        }
                        })
                    </script>